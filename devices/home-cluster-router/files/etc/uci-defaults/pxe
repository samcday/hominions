# Configures dnsmasq for PXE boot.
# This config assumes that:
# * external storage, mounted at `/mnt/storage`, has a tftp/ directory
#   containing iPXE undionly.kpxe + ipxe.efi.
# * /mnt/storage/coreos is bind mounted to `/www/coreos`
# * coreos directory contains a boot.ipxe script.

# iPXE is chainloaded, and then it is instructed to run boot.ipxe script,
# which is loaded from the uHTTPd server (the one that powers LUCI).

# TODO: update reference to source tree that prepares this storage location,
# when it exists.

set -uexo pipefail

uci -q batch <<EOI
set dhcp.@dnsmasq[0].enable_tftp='1'
set dhcp.@dnsmasq[0].tftp_root='/mnt/storage/tftp'
commit dhcp
EOI

cat > /etc/dnsmasq.conf <<HERE
dhcp-match=set:ipxe,175
dhcp-match=set:bios,option:client-arch,0
dhcp-match=set:efi64,option:client-arch,7
dhcp-boot=tag:ipxe,http://10.0.1.1/coreos/boot.ipxe
dhcp-boot=tag:!ipxe,tag:bios,undionly.kpxe
dhcp-boot=tag:!ipxe,tag:efi64,ipxe.efi
HERE

service dnsmasq restart || true
